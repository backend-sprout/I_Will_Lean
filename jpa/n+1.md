# ğŸ« N+1 ë¬¸ì œ 
> ì¡°íšŒ ì‹œ 1ê°œì˜ ì¿¼ë¦¬ë¥¼ ìƒê°í•˜ê³  ì„¤ê³„ë¥¼ í–ˆìœ¼ë‚˜ ë‚˜ì˜¤ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¡°íšŒì˜ ì¿¼ë¦¬ê°€ Nê°œê°€ ë” ë°œìƒí•˜ëŠ” ë¬¸ì œ.
  
ì˜ì†ì„±ì„ ê´€ë¦¬í•˜ì§€ ëª»í•´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë‹¤.     
  
## ğŸ“š ì¤€ë¹„ë¬¼ 
### Team(One)
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class Team {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String teamName;

    @OneToMany
    private List<User> user = new ArrayList<>();

    @Builder
    public Team(final String teamName) {
        this.teamName = teamName;
    }
}
```

### User(Many)
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class User {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String username;

    @ManyToOne
    @JoinColumn(name = "team_id")
    private Team team;

    @Builder
    public User(final String username, final Team team) {
        this.username = username;
        this.team = team;
    }
}
```

### SomenThing
```java
@Entity
public class SomeThing {
    
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    public Long getId() {
        return id;
    }
}
```

### Test
```java
@DataJpaTest
public class NPlusOneTest {

    @Autowired
    private TestEntityManager testEntityManager;

    @Autowired
    private TeamRepository teamRepository;

    @Autowired
    private UserRepository userRepository;

    private List<Team> teams;

    private List<User> users;

    @BeforeEach
    void setUp() {
        teams = IntStream.range(0, 10)
                .mapToObj(i -> "teamName" + i)
                .map(Team::new)
                .collect(Collectors.toList());
        teamRepository.saveAll(teams);

        users = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            for (int j = 0; j < 10; j++) {
                final User user = new User("username" + i + "" + j, teams.get(i));
                users.add(user);
            }
        }
        userRepository.saveAll(users);

        teamRepository.flush();
        userRepository.flush();
        System.out.println("\n\n\n\n\n\n\n\n");
    }
}
```

# ğŸ“• EAGER  
> EAGERëŠ” ê°ì‹¼ ì—”í‹°í‹°(ë‹¨ì¼)ì— ëŒ€í•´ì„œ ì—°ê´€ëœ ì˜ì† ê°ì²´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒ  
  
## ğŸ“– OneToMany
**Team(One)**
```java
    @OneToMany(mappedBy = "team", fetch = FetchType.EAGER)
    private List<User> user = new ArrayList<>();
```

### ğŸ“„ findById  
#### ğŸ§‘ğŸ»â€ğŸ’» ì½”ë“œ 
```java
    @Test
    void oneToManyFindById() {
        testEntityManager.clear();
        final Team team = teamRepository.findById(1L).get();
        System.out.println("=====Start=======");
        team.getUser().stream()
            .map(User::getUsername)
            .forEach(System.out::println);
        System.out.println("=====End=======");
    }
```

#### ğŸ’¡ ê²°ê³¼ 
```shell
=====Start=======
Hibernate: 
    select 
        team0_.id as id1_1_0_, 
        team0_.team_name as team_nam2_1_0_, 
        user1_.team_id as team_id3_2_1_, 
        user1_.id as id1_2_1_, 
        user1_.id as id1_2_2_, 
        user1_.team_id as team_id3_2_2_, 
        user1_.username as username2_2_2_ 
    from team team0_ 
    left outer join user user1_ on team0_.id=user1_.team_id 
    where team0_.id=? 
    // í•œë°© ì¿¼ë¦¬ 
username00
....
username09
=====End=======
```
  
* `findById == Join`   
* Joinì„ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì—, `List<User>`ì— ëŒ€í•œ ì˜ì†ì„±ì„ ì¼ì¼íˆ ê°€ì ¸ì˜¤ëŠ”ê²Œ ì•„ë‹ˆë¼ í•œë²ˆì— ê°€ì ¸ì™”ë‹¤.     

### ğŸ“„ findAll 

#### ğŸ§‘ğŸ»â€ğŸ’» ì½”ë“œ
```java
    @Test
    void oneToManyFindAll() {
        testEntityManager.clear();

        final List<Team> teams = teamRepository.findAll();
        System.out.println("=====Start=======");
        for (Team team : teams) {
            team.getUser().stream()
                    .map(User::getUsername)
                    .forEach(System.out::println);
        }
        System.out.println("=====End=======");
    }
```

#### ğŸ’¡ ê²°ê³¼ 
```shell
=====Start=======
Hibernate: select team0_.id as id1_1_, team0_.team_name as team_nam2_1_ from team team0_
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?

username00
...
username99
=====End=======
```

* findAll()ì€ ì›ë˜ ì¿¼ë¦¬ìƒ `select team0_.id as id1_1_, team0_.team_name as team_nam2_1_ from team team0_`ë¡œ ëë‚œë‹¤.   
* ê·¸ëŸ¬ë‚˜, EAGERì— ë”°ë¼ `íŒ€í•˜ë‚˜ + ì—¬ëŸ¬ ìœ ì €(select user from user where team.id = user.team_id)` êµ¬ë¬¸ì´ ì‹¤í–‰ëœë‹¤.     
* ì•ì„œ ë§í–ˆë“¯ì´ EAGERëŠ” ê°ì‹¼ ì—”í‹°í‹°(ë‹¨ì¼)ì— ëŒ€í•´ì„œ ì—°ê´€ëœ ì˜ì† ê°ì²´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë¯€ë¡œ, ë‹¨ì¼ íŒ€ì— ë§ì¶”ì–´ user selectë¥¼ í˜¸ì¶œí•œ ê²ƒì´ë‹¤.  
* ë” ì‰½ê²Œ ì„¤ëª…í•˜ë©´ EAGERì˜ ê²½ìš° ë¬´ì¡°ê±´ WHEREë¡œ ê²€ìƒ‰í•œë‹¤. 
* ë‹¨, OneToManyì—ì„œëŠ” Joinì´ì§€ë§Œ, ManyToOneì—ì„œëŠ” ê·¸ëƒ¥ where ì ˆë¡œ ê°€ì ¸ì˜¨ë‹¤.(ì¦‰ ManyToOneì€ ì¿¼ë¦¬ê°€ í•œë²ˆ ë” ë‚ ë¼ê°„ë‹¤)  
* ê·¸ë ‡ê¸°ì— `List<Entity>` ì— ëŒ€í•´ì„œ ë‹¨ì¼ë¡œ ë‹¨ìœ„ë¡œ ê°€ì ¸ì™€ì„œ N+1ì´ ë°œìƒí•œë‹¤.    


## ğŸ“– ManyToOne  

**User**
```java
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "team_id", nullable = false)
    private Team team;
```

### ğŸ“„ findById

#### ğŸ§‘ğŸ»â€ğŸ’» ì½”ë“œ  
```java
    @Test
    void manyToOneFindById() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final User user = userRepository.findById(1L).get();
        user.getTeam().getTeamName();
        System.out.println("=====End=======");
    }
```
  
#### ğŸ’¡ ê²°ê³¼  
```java
=====Start=======
Hibernate: select user0_.id as id1_2_0_, user0_.team_id as team_id3_2_0_, user0_.username as username2_2_0_, team1_.id as id1_1_1_, team1_.team_name as team_nam2_1_1_ from user user0_ inner join team team1_ on user0_.team_id=team1_.id where user0_.id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
=====End=======
```

* OneToManyì˜ findByIdëŠ” Join ì´ì—ˆë˜ ê²ƒê³¼ ë‹¬ë¦¬, ManyToOneì˜ findByIdëŠ” Where ë¥¼ í†µí•œ ì¶”ê°€ ì¡°íšŒ ë¡œì§ì´ë‹¤.   
* ì´ë¥¼ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ë‚˜íƒ€ë‚´ë ¤ë©´ ì•„ë¬´ë˜ë„ ì¡°ì¸ì„ ì¨ì•¼í•  ê²ƒ ê°™ë‹¤. 

### ğŸ“„ findByAll
**ì½”ë“œ**
```java
    @Test
    void manyToOneFindAll() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final List<User> users = userRepository.findAll();
        users.stream().map(User::getTeam)
                .map(Team::getTeamName)
                .forEach(System.out::println);
        System.out.println("=====End=======");
    }
```

#### ğŸ’¡ ê²°ê³¼ 
```shell
  =====Start=======
Hibernate: select user0_.id as id1_2_, user0_.team_id as team_id3_2_, user0_.username as username2_2_ from user user0_
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?

teamName0 * 10ê°œ
...
teamName9 * 10ê°œ
=====End=======
```

* EAGERëŠ” ì—”í‹°í‹°(ë‹¨ì¼)ì„ ê¸°ì¤€ìœ¼ë¡œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.     
* ë”ë¶ˆì–´ ManyToOne ì´ë¯€ë¡œ, ê°ê°ì˜ ì—”í‹°í‹°ì— ë§ëŠ” Teamì„ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¤ê³  ìˆë‹¤.     
* ì´ë¥¼ í•´ê²°í•˜ë ¤ë©´ ë§ˆì°¬ê°€ì§€ë¡œ ì¡°ì¸ì„ í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤.  


