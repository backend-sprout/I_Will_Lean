# ğŸ« N+1 ë¬¸ì œ 
> ì¡°íšŒ ì‹œ 1ê°œì˜ ì¿¼ë¦¬ë¥¼ ìƒê°í•˜ê³  ì„¤ê³„ë¥¼ í–ˆìœ¼ë‚˜ ë‚˜ì˜¤ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¡°íšŒì˜ ì¿¼ë¦¬ê°€ Nê°œê°€ ë” ë°œìƒí•˜ëŠ” ë¬¸ì œ.
  
ì˜ì†ì„±ì„ ê´€ë¦¬í•˜ì§€ ëª»í•´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë‹¤.     
  
## ğŸ“š ì¤€ë¹„ë¬¼ 
### Team(One)
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class Team {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String teamName;

    @OneToMany
    private List<User> user = new ArrayList<>();

    @Builder
    public Team(final String teamName) {
        this.teamName = teamName;
    }
}
```

### User(Many)
```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class User {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String username;

    @ManyToOne
    @JoinColumn(name = "team_id")
    private Team team;

    @Builder
    public User(final String username, final Team team) {
        this.username = username;
        this.team = team;
    }
}
```

### SomenThing
```java
@Entity
public class SomeThing {
    
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    public Long getId() {
        return id;
    }
}
```

### Test
```java
@DataJpaTest
public class NPlusOneTest {

    @Autowired
    private TestEntityManager testEntityManager;

    @Autowired
    private TeamRepository teamRepository;

    @Autowired
    private UserRepository userRepository;

    private List<Team> teams;

    private List<User> users;

    @BeforeEach
    void setUp() {
        teams = IntStream.range(0, 10)
                .mapToObj(i -> "teamName" + i)
                .map(Team::new)
                .collect(Collectors.toList());
        teamRepository.saveAll(teams);

        users = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            for (int j = 0; j < 10; j++) {
                final User user = new User("username" + i + "" + j, teams.get(i));
                users.add(user);
            }
        }
        userRepository.saveAll(users);

        teamRepository.flush();
        userRepository.flush();
        System.out.println("\n\n\n\n\n\n\n\n");
    }

    @Test
    void oneToManyFindById() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final Team team = teamRepository.findById(1L).get();
        team.getUser().stream()
                .map(User::getUsername)
                .forEach(System.out::println);
        System.out.println("=====End=======");
    }

    @Test
    void oneToManyFindAll() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final List<Team> teams = teamRepository.findAll();
        for (Team team : teams) {
            team.getUser().stream()
                    .map(User::getUsername)
                    .forEach(System.out::println);
        }
        System.out.println("=====End=======");
    }

    @Test
    void manyToOneFindById() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final User user = userRepository.findById(1L).get();
        user.getTeam().getTeamName();
        System.out.println("=====End=======");
    }

    @Test
    void manyToOneFindAll() {
        testEntityManager.clear();

        System.out.println("=====Start=======");
        final List<User> users = userRepository.findAll();
        users.stream().map(User::getTeam)
                .map(Team::getTeamName)
                .forEach(System.out::println);
        System.out.println("=====End=======");
    }
}
```

# ğŸ“• EAGER  
> EAGERëŠ” ê°ì‹¼ ì—”í‹°í‹°(ë‹¨ì¼)ì— ëŒ€í•´ì„œ ì—°ê´€ëœ ì˜ì† ê°ì²´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒ  
  
## ğŸ“– OneToMany
**Team(One)**
```java
    @OneToMany(mappedBy = "team", fetch = FetchType.EAGER)
    private List<User> user = new ArrayList<>();
```

### ğŸ“„ findById  
#### ğŸ’¡ ê²°ê³¼ 
```shell
=====Start=======
Hibernate: 
    select 
        team0_.id as id1_1_0_, 
        team0_.team_name as team_nam2_1_0_, 
        user1_.team_id as team_id3_2_1_, 
        user1_.id as id1_2_1_, 
        user1_.id as id1_2_2_, 
        user1_.team_id as team_id3_2_2_, 
        user1_.username as username2_2_2_ 
    from team team0_ 
    left outer join user user1_ on team0_.id=user1_.team_id 
    where team0_.id=? 
    // í•œë°© ì¿¼ë¦¬ 
username00
....
username09
=====End=======
```
  
* `findById == Join`   
* Joinì„ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì—, `List<User>`ì— ëŒ€í•œ ì˜ì†ì„±ì„ ì¼ì¼íˆ ê°€ì ¸ì˜¤ëŠ”ê²Œ ì•„ë‹ˆë¼ í•œë²ˆì— ê°€ì ¸ì™”ë‹¤.     

### ğŸ“„ findAll 
#### ğŸ’¡ ê²°ê³¼ 
```shell
=====Start=======
Hibernate: select team0_.id as id1_1_, team0_.team_name as team_nam2_1_ from team team0_
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?

username00
...
username99
=====End=======
```

* findAll()ì€ ì›ë˜ ì¿¼ë¦¬ìƒ `select team0_.id as id1_1_, team0_.team_name as team_nam2_1_ from team team0_`ë¡œ ëë‚œë‹¤.   
* ê·¸ëŸ¬ë‚˜, EAGERì— ë”°ë¼ `íŒ€í•˜ë‚˜ + ì—¬ëŸ¬ ìœ ì €(select user from user where team.id = user.team_id)` êµ¬ë¬¸ì´ ì‹¤í–‰ëœë‹¤.     
* ì•ì„œ ë§í–ˆë“¯ì´ EAGERëŠ” ê°ì‹¼ ì—”í‹°í‹°(ë‹¨ì¼)ì— ëŒ€í•´ì„œ ì—°ê´€ëœ ì˜ì† ê°ì²´ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë¯€ë¡œ, ë‹¨ì¼ íŒ€ì— ë§ì¶”ì–´ user selectë¥¼ í˜¸ì¶œí•œ ê²ƒì´ë‹¤.  
* ë” ì‰½ê²Œ ì„¤ëª…í•˜ë©´ EAGERì˜ ê²½ìš° ë¬´ì¡°ê±´ WHEREë¡œ ê²€ìƒ‰í•œë‹¤. 
* ë‹¨, OneToManyì—ì„œëŠ” Joinì´ì§€ë§Œ, ManyToOneì—ì„œëŠ” ê·¸ëƒ¥ where ì ˆë¡œ ê°€ì ¸ì˜¨ë‹¤.(ì¦‰ ManyToOneì€ ì¿¼ë¦¬ê°€ í•œë²ˆ ë” ë‚ ë¼ê°„ë‹¤)  
* ê·¸ë ‡ê¸°ì— `List<Entity>` ì— ëŒ€í•´ì„œ ë‹¨ì¼ë¡œ ë‹¨ìœ„ë¡œ ê°€ì ¸ì™€ì„œ N+1ì´ ë°œìƒí•œë‹¤.    


## ğŸ“– ManyToOne  

**User**
```java
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "team_id", nullable = false)
    private Team team;
```

### ğŸ“„ findById
#### ğŸ§‘ğŸ»â€ğŸ’» ì½”ë“œ - Teamì˜ OneToManyê°€ EAGER ì¸ ê²½ìš°
**Teamì´ Eager ê°€ì§ˆê²½ìš°**
```java
    @OneToMany(mappedBy = "team", fetch = FetchType.EAGER)
    private List<User> user = new ArrayList<>();
```
#### ğŸ’¡ ê²°ê³¼  
```java
=====Start=======
Hibernate: select user0_.id as id1_2_0_, user0_.team_id as team_id3_2_0_, user0_.username as username2_2_0_, team1_.id as id1_1_1_, team1_.team_name as team_nam2_1_1_ from user user0_ inner join team team1_ on user0_.team_id=team1_.id where user0_.id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
=====End=======
```

* OneToManyì˜ findByIdëŠ” Join ì´ì—ˆë˜ ê²ƒê³¼ ë‹¬ë¦¬, ManyToOneì˜ findByIdëŠ” Where ë¥¼ í†µí•œ ì¶”ê°€ ì¡°íšŒ ë¡œì§ì´ë‹¤.   
* ì•„ë§ˆë„ Joinì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ EAGER + ManyToOne íŠ¹ì§•ì— ë”°ë¼ ì—”í‹°í‹°ì— ë§ëŠ” Teamì„ ì°¾ì€ ê²ƒ ê°™ë‹¤.    
* ì•„ë˜ ë‚˜ì˜¬ findAll ì»¬ë ‰ì…˜ì„ ë°˜í™˜í•˜ë‹ˆê¹Œ ì´ êµ¬ë¬¸ì„ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•œ ëŠë‚Œì´ë‹¤.     
* ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¹ì—°í•˜ê²Œë„ ì¡°ì¸ì„ í•´ì•¼í•œë‹¤.       


#### ğŸ§‘ğŸ»â€ğŸ’» ì½”ë“œ2 - Teamì˜ OneToManyê°€ LAZY ì¸ ê²½ìš°
```java
    @OneToMany(mappedBy = "team", fetch = FetchType.LAZY)
    private List<User> user = new ArrayList<>();
```

* Teamì˜ OneToManyê°€ Lazyì¸ ê²½ìš°, Join ë¬¸ì„ ì‹¤í–‰í•œë‹¤; 

#### ğŸ’¡ ê²°ê³¼ 

![image](https://user-images.githubusercontent.com/50267433/146043018-84f058e5-cc58-4f9d-be9c-e51cb7bb0dde.png)


### ğŸ“„ findByAll  
#### ğŸ’¡ ê²°ê³¼ 
```shell
  =====Start=======
Hibernate: select user0_.id as id1_2_, user0_.team_id as team_id3_2_, user0_.username as username2_2_ from user user0_
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.id as id1_2_1_, user1_.id as id1_2_2_, user1_.team_id as team_id3_2_2_, user1_.username as username2_2_2_ from team team0_ left outer join user user1_ on team0_.id=user1_.team_id where team0_.id=?

teamName0 * 10ê°œ
...
teamName9 * 10ê°œ
=====End=======
```

* EAGERëŠ” ì—”í‹°í‹°(ë‹¨ì¼)ì„ ê¸°ì¤€ìœ¼ë¡œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.     
* ë”ë¶ˆì–´ ManyToOne ì´ë¯€ë¡œ, ê°ê°ì˜ ì—”í‹°í‹°ì— ë§ëŠ” Teamì„ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¤ê³  ìˆë‹¤.     
* ì´ë¥¼ í•´ê²°í•˜ë ¤ë©´ ë§ˆì°¬ê°€ì§€ë¡œ ì¡°ì¸ì„ í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤.  

# ğŸ“• LAZY
## OneToMany 
**Team(One)**  
```java
    @OneToMany(mappedBy = "team", fetch = FetchType.LAZY)
    private List<User> user = new ArrayList<>();
```

### findById
#### ğŸ’¡ ê²°ê³¼
```java
=====Start=======
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username00
...
username09
=====End=======
```

* LAZY íƒ€ì…ìœ¼ë¡œ ë˜ì–´ìˆê¸° ë•Œë¬¸ì—, Joinì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  í”„ë¡ì‹œë¥¼ ê°€ì ¸ì˜¨ë‹¤.  
* í”„ë¡ì‹œ ìƒíƒœì˜ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— `List<User>`ë¥¼ ê°€ì ¸ì˜¤ëŠ” `select ì¿¼ë¦¬` í•˜ë‚˜ë¥¼ í˜¸ì¶œí•œë‹¤

### findAll
#### ğŸ’¡ ê²°ê³¼ 

```shell
=====Start=======
Hibernate: select team0_.id as id1_1_, team0_.team_name as team_nam2_1_ from team team0_
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username00
...
username09
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username10
...
username19
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username20
...
username29
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username30
...
username39
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username40
...
username49
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username50
...
username59
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username60
...
username69
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username70
...
username79
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username80
...
username89
Hibernate: select user0_.team_id as team_id3_2_0_, user0_.id as id1_2_0_, user0_.id as id1_2_1_, user0_.team_id as team_id3_2_1_, user0_.username as username2_2_1_ from user user0_ where user0_.team_id=?
username90
...
username99
=====End=======
```

* LAZY íƒ€ì…ìœ¼ë¡œ ë˜ì–´ìˆê¸° ë•Œë¬¸ì—, ê°ê°ì˜ Team ì—”í‹°í‹°ì˜ `List<User>`ëŠ” í”„ë¡ì‹œë¡œ ë˜ì–´ìˆë‹¤.   
* í”„ë¡ì‹œ ìƒíƒœì´ê¸° ë•Œë¬¸ì—, ê°ê°ì˜ Team ì—”í‹°í‹° í•˜ë‚˜ë§ˆë‹¤ `List<User>`ë¥¼ ê°€ì ¸ì˜¤ëŠ” select ì¿¼ë¦¬ë¥¼ í˜¸ì¶œí•˜ê³  ìˆë‹¤.     

## ManyToOne
```java
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id", nullable = false)
    private Team team;
```

### findById
#### ğŸ’¡ ê²°ê³¼  
```shell
=====Start=======
Hibernate: select user0_.id as id1_2_0_, user0_.team_id as team_id3_2_0_, user0_.username as username2_2_0_ from user user0_ where user0_.id=?
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
=====End=======
```
* Lazyì´ê¸° ë•Œë¬¸ì—, `Team`ì— ê´€í•´ì„œ í”„ë¡ì‹œë¥¼ ë§Œë“ ë‹¤.    
* í”„ë¡ì‹œ ìƒíƒœì´ê¸° ë•Œë¬¸ì—, where ë¡œ íŒ€ì„ ì¡°íšŒí•œë‹¤.     

### findAll
#### ğŸ’¡ ê²°ê³¼ 
```shell
=====Start=======
Hibernate: select user0_.id as id1_2_, user0_.team_id as team_id3_2_, user0_.username as username2_2_ from user user0_
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName0
...
teamName0
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName1
...
teamName1
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName2
...
teamName2
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName3
...
teamName3
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName4
...
teamName4
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName5
...
teamName5
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName6
...
teamName6
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName7
...
teamName7
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName8
...
teamName8
Hibernate: select team0_.id as id1_1_0_, team0_.team_name as team_nam2_1_0_ from team team0_ where team0_.id=?
teamName9
...
teamName9
=====End=======
```
* ë§ˆì°¬ê°€ì§€ë¡œ, ë‹¨ì¼ ì—”í‹°í‹°ì— ëŒ€í•´ì„œ ê°ê°ì˜ Teamì€ í”„ë¡ì‹œ ìƒíƒœì´ë‹¤.  
* í”„ë¡ì‹œ ìƒíƒœì´ê¸° ë•Œë¬¸ì—, ê°ê°ì˜ ì—”í‹°í‹°ì˜ Teamì— ëŒ€í•´ì„œ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•œë‹¤.  

# ê²°ë¡  
## EAGER

||OneToMany|ManyToOne|ì¡°íšŒì£¼ì²´|ë¡œì§|ê²°ê³¼|ì´ìœ |
|-|--------|---------|------|---|--|---|
||EAGER|EAGER|Team|findById|Join ì¿¼ë¦¬(1íšŒ)|ì˜ˆì™¸ì ì¸ ì¼€ì´ìŠ¤ë¡œ ì¡°íšŒì‹œ ìµœì í™”|
||EAGER|EAGER|Team|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||EAGER|EAGER|User|findById|Where ì¿¼ë¦¬(2íšŒ(N+1))|ìµœì í™” X, User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|
||EAGER|EAGER|User|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|
||EAGER|LAZY|Team|findById|Join ì¿¼ë¦¬(1íšŒ)|ì˜ˆì™¸ì ì¸ ì¼€ì´ìŠ¤ë¡œ ì¡°íšŒì‹œ ìµœì í™”|
||EAGER|LAZY|Team|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|EAGER|User|findById|Join ì¿¼ë¦¬(1íšŒ)|ì˜ˆì™¸ì ì¸ ì¼€ì´ìŠ¤ë¡œ ì¡°íšŒì‹œ ìµœì í™”|
||LAZY|EAGER|User|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|

## LAZY

||OneToMany|ManyToOne|ì¡°íšŒì£¼ì²´|ë¡œì§|ê²°ê³¼|ì´ìœ |
|-|--------|---------|------|---|--|---|
||LAZY|LAZY|Team|findById|Where ì¿¼ë¦¬(2íšŒ(N+1))|ìµœì í™” X, Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|LAZY|Team|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|LAZY|User|findById|Where ì¿¼ë¦¬(2íšŒ(N+1))|ìµœì í™” X, User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|LAZY|User|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|EAGER|Team|findById|Where ì¿¼ë¦¬(2íšŒ(N+1))|ìµœì í™” X, Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||LAZY|EAGER|Team|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° Team ì—”í‹°í‹°ì˜ User ì¡°íšŒ Where ìˆ˜í–‰|
||EAGER|LAZY|User|findById|Where ì¿¼ë¦¬(2íšŒ(N+1))|ìµœì í™” X, User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|
||EAGER|LAZY|User|findByAll|Where ì¿¼ë¦¬(N+1íšŒ)|ê° User ì—”í‹°í‹°ì˜ Team ì¡°íšŒ Where ìˆ˜í–‰|

* ìµœì†Œ 2ë²ˆì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.    
* findByIdëŠ” Eagerì¼ ê²½ìš° Join ìµœì í™”(ë‹¨, EAGER/EAGER ìœ ì €(Many)ì—ì„œ ê²€ìƒ‰ì€ ì˜ˆì™¸)

  
# ğŸ¤” í•´ê²°ë²•  
## JPQL ì‚¬ìš©(Where ëŒ€ì‹  FetchJoin ì‚¬ìš©í•˜ê¸°)    

* where ì‚¬ìš©í•œë‹¤ë©´? : Join ìµœì í™” ì—†ì´ ëª¨ë“  ì¡°íšŒê°€ N+1ì´ ë°œìƒí•  ê²ƒì´ë‹¤(ê¸°ì¡´ ì¡°ì¸ ìµœì í™”ë„ ì—†ì•¨ ê²ƒì´ë¯€ë¡œ)  
* ê·¸ëƒ¥ Joinì€? : ê·¸ëƒ¥ ì¡°ì¸ì€ í…Œì´ë¸”ì„ ì—°ê²°í•´ì„œ ê°’ì„ ê°€ì ¸ì˜¤ì§€ë§Œ, ì˜ì†ì„±ì„ ê°€ì ¸ì˜¤ì§€ ì•Šê¸° ë•Œë¬¸ì— í˜¸ì¶œì‹œ ì˜ì†ì„± ì¡°íšŒ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°„ë‹¤.  

### Team
#### TeamRepository
```java
public interface TeamRepository extends JpaRepository<Team, Long> {

    @Query("select t from Team t join fetch t.user where t.id =:id")
    Optional<Team> findByIdFetchJoin(final Long id);

    @Query("select t from Team t join fetch t.user")
    List<Team> findAllFetchJoin();

    @Query("select t from Team t join fetch t.user")
    Set<Team> findAllFetchJoinSet();

    @Query("select distinct t from Team t join fetch t.user")
    List<Team> findAllFetchJoinDistinct();
}
```

#### findByIdFetchJoin
```shell
=====Start=======
Hibernate: select team0_.id as id1_1_0_, user1_.id as id1_2_1_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.username as username2_2_1_, user1_.team_id as team_id3_2_0__, user1_.id as id1_2_0__ from team team0_ inner join user user1_ on team0_.id=user1_.team_id where team0_.id=?
=====End=======
```
* ë‹¨ì¼ ìš”ì†Œì— ëŒ€í•´ì„œ ê²€ìƒ‰ + íŒ¨ì¹˜ì¡°ì¸ì´ê¸°ì— ì¿¼ë¦¬ê°€ í•œë²ˆ ë‚˜ê°„ë‹¤.  

#### findAllFetchJoin

```shell
Hibernate: select team0_.id as id1_1_0_, user1_.id as id1_2_1_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.username as username2_2_1_, user1_.team_id as team_id3_2_0__, user1_.id as id1_2_0__ from team team0_ inner join user user1_ on team0_.id=user1_.team_id

10ë²ˆ ë°˜ë³µ -> ì¤‘ë³µëœ ë°ì´í„° ê³„ì† ì¶œë ¥ 
[ username00 ]
| username01 |
[ .......... ]

10ë²ˆ ë°˜ë³µ -> ì¤‘ë³µëœ ë°ì´í„° ê³„ì† ì¶œë ¥ 
[ username10 ]
| username11 |
[ .......... ]

... * 10
```
* ë§ˆì°¬ê°€ì§€ë¡œ ì¡°ì¸ì„ ì´ìš©í–ˆê¸°ì— ì¿¼ë¦¬í•œë°©ìœ¼ë¡œ í•´ê²°ì´ ê°€ëŠ¥í•˜ë‹¤.   
* ë‹¨, oneToManyê°™ì€ ê²½ìš°, í•˜ë‚˜ì˜ ì—”í‹°í‹°ì— ì—¬ëŸ¬ ê°’ì´ ì¡´ì¬í•˜ë¯€ë¡œ 
* ê¸°ë³¸ì ì¸ í–‰ì˜ ê°œìˆ˜ëŠ” Many ë¶€ë¶„ì˜ ê°œìˆ˜ë§Œí¼ ì¦ê°€í•œë‹¤(Many ê°’ì´ í•˜ë‚˜ì”© ë“¤ì–´ê°€ë‹ˆê¹Œ)

#### findAllFetchJoinSet/findAllFetchJoinDistinct(findAllFetchJoin - í•´ê²°)
  
```shell
=====Start=======
Hibernate: select team0_.id as id1_1_0_, user1_.id as id1_2_1_, team0_.team_name as team_nam2_1_0_, user1_.team_id as team_id3_2_1_, user1_.username as username2_2_1_, user1_.team_id as team_id3_2_0__, user1_.id as id1_2_0__ from team team0_ inner join user user1_ on team0_.id=user1_.team_id
username00
username01
...
username99
```
* Set/ì´ë‚˜ distinctë¥¼ ì‚¬ìš©í•˜ë©´ OneToManyì— ëŒ€í•´ì„œ ìµœì í™”ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤.          
* ë‘ ë°©ì‹ ëª¨ë‘ ë°ì´í„°ë² ì´ìŠ¤/ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ê°’ì„ ë“¤ì—¬ì˜¤ê¸° ë•Œë¬¸ì´ë‹¤.      
* **ë‹¨, ì´ë ‡ê²Œ í•˜ë”ë¼ë„ OneToMany íŒ¨ì¹˜ì¡°ì¸ì— ëŒ€í•´ì„œ í˜ì´ì§•ì„ ì§„í–‰í•  ìˆ˜ ì—†ë‹¤.**     

#### í˜ì´ì§• 

```java
    @EntityGraph(attributePaths = {"users"}, type = EntityGraph.EntityGraphType.FETCH)
    @Query("select t from Team t")
    Page<Team> findAllPaging(Pageable pageable);

    @EntityGraph(attributePaths = {"users"}, type = EntityGraph.EntityGraphType.FETCH)
    @Query("select distinct t from Team t")
    Page<Team> findAllPagingDistinct(Pageable pageable);
```

```java
    @Test
    void oneToManyPaging() {
        System.out.println("=====Start=======");
        final Page<Team> teams = teamRepository.findAllPaging(PageRequest.of(0, 20));
        for (Team team : teams) {
            team.getUsers().stream()
                    .map(User::getUsername)
                    .forEach(System.out::println);
        }
        System.out.println("=====End=======");
    }

    @Test
    void oneToManyPagingDistinct() {
        System.out.println("=====Start=======");
        final Page<Team> teams = teamRepository.findAllPagingDistinct(PageRequest.of(0, 20));
        for (Team team : teams) {
            team.getUsers().stream()
                    .map(User::getUsername)
                    .forEach(System.out::println);
        }
        System.out.println("=====End=======");
    }
```

```shell
=====Start=======
2021-12-15 16:45:36.554  WARN 14523 --- [           main] o.h.h.internal.ast.QueryTranslatorImpl   : HHH000104: firstResult/maxResults specified with collection fetch; applying in memory!
Hibernate: select distinct team0_.id as id1_1_0_, users1_.id as id1_2_1_, team0_.team_name as team_nam2_1_0_, users1_.team_id as team_id3_2_1_, users1_.username as username2_2_1_, users1_.team_id as team_id3_2_0__, users1_.id as id1_2_0__ from team team0_ left outer join user users1_ on team0_.id=users1_.team_id
=====End=======
```  
* ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê²ƒì€ WARN ë¡œê·¸ì´ë‹¤.      
* firstResult/maxResults specified with collection fetch; applying in memory!   
* ì½œë ‰ì…˜ íŒ¨ì¹˜ì— ëŒ€í•´ì„œ ì¸ë©”ëª¨ë¦¬ì—ì„œ ì²˜ë¦¬í•˜ê² ë‹¤ê³  ì¨ì ¸ìˆë‹¤.    
* 1000 1000 ì—ì„œëŠ” ìš°ì„  ì—ëŸ¬ëŠ” ì•ˆí„°ì¡ŒëŠ”ë°, ê°ì²´ê°€ ë§ì•„ì§€ë©´ OOM(OutOfMemeory)ì´ í„°ì§„ë‹¤     

# ManyToOne




# ì‹ ê¸°í•œê±° 
## OneToMany í˜ì´ì§• í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë ¤ë©´ EntityGraphë¥¼ ì´ìš©í•˜ì 
![image](https://user-images.githubusercontent.com/50267433/146140478-052a54ad-952b-4ffc-ba8f-95b6dcf8b180.png)
![image](https://user-images.githubusercontent.com/50267433/146140618-9c1fef62-4694-4d5e-8093-8864bf46673d.png)

* ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´, ì—ëŸ¬ê°€ í„°ì§„ë‹¤. 

![image](https://user-images.githubusercontent.com/50267433/146140580-01d57091-1709-47c1-bdf3-ae83183dc826.png)

```shell
=====Start=======
2021-12-15 16:15:53.575  WARN 14332 --- [           main] o.h.h.internal.ast.QueryTranslatorImpl   : HHH000104: firstResult/maxResults specified with collection fetch; applying in memory!
Hibernate: select team0_.id as id1_1_0_, users1_.id as id1_2_1_, team0_.team_name as team_nam2_1_0_, users1_.team_id as team_id3_2_1_, users1_.username as username2_2_1_, users1_.team_id as team_id3_2_0__, users1_.id as id1_2_0__ from team team0_ inner join user users1_ on team0_.id=users1_.team_id
=====End=======
```

* ì´ë ‡ê²Œ í•´ì•¼ OneToMany í˜ì´ì§• ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë‹¤.
* ê·¼ë° ë” ì›ƒê¸´ê±´, ì‹¤í–‰ì€ ë˜ëŠ”ë° íŒ¨ì¹˜ ì¡°ì¸ì´ ì•ˆë˜ì–´ì„œ userNameì„ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.  
* ì¦‰, ë‘˜ì´ ê°™ì´ ì‚¬ìš© ëª»í•˜ë‹ˆê¹Œ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í˜ì´ì§•ì´ ì ìš©ë˜ê³ , íŒ¨ì¹˜ ì¡°ì¸ì¸ ì•ˆëœë‹¤.(ëŒ€ì‹  ì—ëŸ¬ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìœ¼ë‹ˆ ê·¸ê±°ë¡œ ë§Œì¡±í•˜ì)

```java
    @Test
    void oneToManyPaging() {
        System.out.println("=====Start=======");
        final List<Team> teams = entityManager.createQuery("select t from Team t join fetch t.users", Team.class)
                .setFirstResult(1)
                .setMaxResults(20)
                .getResultList();
        for (Team team : teams) {
            team.getUsers().stream()
                    .map(User::getUsername)
                    .forEach(System.out::println);
        }
        System.out.println("=====End=======");
    }
```

ì°¸ê³ ë¡œ ìˆœìˆ˜ JPAë¥¼ ì‚¬ìš©í•´ë„ ë§ˆì°¬ê°€ì§€ì´ë‹¤.  

## í˜ì´ì§•ì—ì„œ í˜ì´ì§•ì´ 2ê°œì´ìƒì´ ë˜ë©´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤.

![image](https://user-images.githubusercontent.com/50267433/146140821-b093e991-e9fa-4cf7-b6b1-c8253491a559.png)

